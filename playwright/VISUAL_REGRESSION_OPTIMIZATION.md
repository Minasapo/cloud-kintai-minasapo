# ビジュアルリグレッションテスト パフォーマンス最適化

## 改善概要

ビジュアルリグレッションテストの実行時間を大幅に削減するために、以下の最適化を実施しました。

## 主な改善内容

### 1. **重複テストの削除** ⚡ 大幅な時間短縮

**問題点:**
- 各ページで「画面全体」と「ファーストビュー」の2つのスクリーンショットを取得していた
- フルページスクリーンショットにファーストビューが含まれるため、重複していた
- スタッフページ: 10ページ × 2テスト = 20テスト
- 管理者ページ: 10ページ × 2テスト = 20テスト

**改善:**
```typescript
// 修正前
test(`${page.name} - 画面全体`, ...)
test(`${page.name} - ファーストビュー`, ...)

// 修正後
test(`${page.name}`, ...) // フルページスクリーンショットのみ
```

**削減されたテスト数（visual-regression.spec.ts）:**
- スタッフテスト: 20 → 10 (10テスト削減)
- 管理者テスト: 20 → 10 (10テスト削減)
- レスポンシブテスト: 4テスト（変更なし）
- デバッグテスト: 1テスト（変更なし）
- **合計: 約20テスト削減（45テスト → 25テスト、約44%削減）**

### 2. **不要なログイン処理の削除** ⏱️ 数十秒の短縮

**問題点:**
- 各テストの`beforeEach`でログイン処理を実行していた
- しかし、`storageState`を使用しているため、セッションは既に確立済み
- 不要なログイン処理により、テストごとに2-3秒の余分な時間がかかっていた

**改善:**
```typescript
// 修正前
test.beforeEach(async ({ page }) => {
  await performLogin(page, username, password); // 不要な処理
});

// 修正後
// storageStateを使用するため、ログイン処理は不要
```

**時間短縮:**
- 1テストあたり約2-3秒削減
- 25テスト（スタッフ10 + 管理者10 + レスポンシブ4 + デバッグ1）× 2.5秒 = **約63秒（1分）の短縮**

### 3. **待機時間の最適化** ⏱️ 数十秒の短縮

**問題点:**
- `waitForPageReady`関数で最大3秒待機していた
- MutationObserverのチェック間隔が500msと長かった
- レイアウト調整の待機時間が1000msと長かった

**改善:**
```typescript
// 修正前
const maxWait = 3000; // 3秒
setTimeout(..., 500); // 500ms
await playwrightPage.waitForTimeout(1000); // 1秒

// 修正後
const maxWait = 2000; // 2秒
setTimeout(..., 300); // 300ms
await playwrightPage.waitForTimeout(500); // 500ms
```

**時間短縮:**
- 各テストで約1-1.5秒短縮
- 25テスト × 1.2秒 = **約30秒の短縮**

### 4. **プロジェクト分離の最適化** 🎯 効率化

**問題点:**
- 管理者テストが`chromium-staff`プロジェクトでも実行されていた
- 実行されるがすべてスキップされるため、無駄な処理が発生していた

**改善:**
```typescript
// 修正前
test.skip(
  testInfo.project.name === "chromium-staff",
  "スタッフ権限ではスキップ"
);

// 修正後
test.skip(
  testInfo.project.name !== "chromium-admin",
  "管理者プロジェクトでのみ実行"
);
```

**効果:**
- テストのスキップ処理が最小化
- テスト実行計画が明確化

### 5. **並列実行の強化** 🚀 CI環境での高速化

**問題点:**
- CI環境でworkerが1に設定されており、順次実行されていた

**改善:**
```typescript
// 修正前
workers: process.env.CI ? 1 : undefined,

// 修正後
workers: process.env.CI ? 2 : undefined,
```

**効果:**
- CI環境でも並列実行が有効化
- CI実行時間が最大50%短縮される可能性

## 総合的な改善効果

### テストケース数（visual-regression.spec.ts のみ）
- **修正前: 約45テスト**
  - スタッフ: 20テスト（10ページ × 2）
  - 管理者: 20テスト（10ページ × 2）
  - レスポンシブ: 4テスト
  - デバッグ: 1テスト
- **修正後: 約25テスト**
  - スタッフ: 10テスト（10ページ × 1）
  - 管理者: 10テスト（10ページ × 1）
  - レスポンシブ: 4テスト
  - デバッグ: 1テスト
- **削減率: 約44%（20テスト削減）**

### 実行時間（推定）
仮に各テストが平均10秒かかる場合：

- **修正前: 45 × 10秒 = 約450秒（7分30秒）**
- **修正後の内訳:**
  - テスト削減: 25テスト
  - ログイン処理削減: 2.5秒/テスト削減
  - 待機時間短縮: 1.2秒/テスト削減
  - 実質: 25 × (10 - 2.5 - 1.2) = 25 × 6.3 = 約158秒（2分38秒）
  
- **改善率: 約65%の時間短縮（7分30秒 → 2分38秒）**
- **並列実行により、実際にはさらに短縮される可能性**

### chromium-staffプロジェクトでの実行（主に利用されるケース）
- **修正前: スタッフ20 + 管理者20（スキップ） + レスポンシブ4 + デバッグ1 = 45テスト**
  - 実質実行: スタッフ20 + レスポンシブ4 + デバッグ1 = 25テスト
  - スキップ処理: 管理者20テスト
  - 時間: 約250秒（4分10秒） + スキップのオーバーヘッド
  
- **修正後: スタッフ10 + 管理者10（スキップ） + レスポンシブ4 + デバッグ1 = 25テスト**
  - 実質実行: スタッフ10 + レスポンシブ4 + デバッグ1 = 15テスト
  - スキップ処理: 管理者10テスト（削減）
  - 時間: 約95秒（1分35秒）
  - **改善率: 約62%の時間短縮**

## 追加の最適化提案

さらなる高速化を望む場合、以下の追加施策を検討できます：

### 1. **選択的テストの実行**
```bash
# 重要なページのみテスト
npm run test:e2e -- visual-regression --grep="勤怠一覧|ワークフロー"

# 変更があったページのみテスト
npm run test:e2e -- visual-regression --grep="/attendance/"
```

### 2. **スクリーンショット比較設定の調整**
```typescript
// より緩い比較設定で高速化
maxDiffPixels: 150, // 100 → 150
threshold: 0.25,    // 0.2 → 0.25
```

### 3. **デバッグテストの分離**
```typescript
// デバッグ用テストを別のテストファイルに移動
// visual-regression-debug.spec.ts
```

### 4. **ビューポートテストの削減**
レスポンシブテストを主要ページのみに限定：
```typescript
// モバイル/デスクトップテストを2ページに限定（現在の実装）
// 必要に応じてさらに削減可能
```

## 実行方法

### 最適化されたテストの実行
```bash
# スタッフユーザーテスト
npm run test:e2e -- visual-regression --project=chromium-staff

# 管理者ユーザーテスト
npm run test:e2e -- visual-regression --project=chromium-admin

# 両方（並列実行）
npm run test:e2e -- visual-regression
```

### ベースライン更新
```bash
npm run test:e2e -- visual-regression --project=chromium-staff --update-snapshots
npm run test:e2e -- visual-regression --project=chromium-admin --update-snapshots
```

## 注意事項

1. **ベースラインの更新が必要**
   - スクリーンショットのファイル名が変更されているため、ベースラインの再取得が必要です
   - `--update-snapshots`オプションで実行してください

2. **既存のスナップショットの削除**
   - 古いスナップショット（`-full.png`, `-viewport.png`）は削除可能です
   ```bash
   # 古いスナップショットを削除
   find playwright/tests -name "*-full.png" -delete
   find playwright/tests -name "*-viewport.png" -delete
   ```

3. **CI環境での並列実行**
   - CI環境でworker数が2に増えたため、リソースに注意してください
   - 必要に応じて調整可能です

## まとめ

この最適化により、ビジュアルリグレッションテストの実行時間が**約50-60%短縮**され、より迅速なフィードバックサイクルが実現されます。テストの品質を維持しながら、開発効率が大幅に向上します。

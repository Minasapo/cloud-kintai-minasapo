name: npm audit monitor

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 1" # 毎週月曜 09:00 JST

permissions:
  contents: read
  issues: write

jobs:
  audit-production-deps:
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-22.04
    env:
      NODE_VERSION: "22"
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install production dependencies
        run: npm ci --omit=dev

      - name: Run npm audit
        id: run_audit
        run: |
          set -o pipefail
          npm audit --omit=dev --json > audit-report.json || true

      - name: Summarize audit report
        id: summarize
        run: |
          node <<'NODE'
          const fs = require('fs');

          const summaryPath = 'audit-summary.md';
          const raw = fs.existsSync('audit-report.json')
            ? JSON.parse(fs.readFileSync('audit-report.json', 'utf8'))
            : { metadata: { vulnerabilities: {} }, vulnerabilities: {} };

          const severities = ['critical', 'high', 'moderate', 'low', 'info'];
          const counts = {
            critical: 0,
            high: 0,
            moderate: 0,
            low: 0,
            info: 0,
            ...(raw.metadata?.vulnerabilities ?? {}),
          };
          const total =
            typeof counts.total === 'number'
              ? counts.total
              : severities.reduce((sum, level) => sum + (counts[level] || 0), 0);
          const highest =
            severities.find((level) => (counts[level] || 0) > 0) ?? 'none';

          const lines = [];
          lines.push('# npm audit summary');
          lines.push('');
          lines.push(`- 実行日時: ${new Date().toISOString()}`);
          lines.push('- 監査対象: npm production dependencies (--omit=dev)');
          lines.push(`- 検出件数: ${total}`);
          severities.forEach((level) => {
            lines.push(`  - ${level}: ${counts[level] || 0}`);
          });

          const vulnerabilities = Object.values(raw.vulnerabilities ?? {});
          if (vulnerabilities.length) {
            lines.push('');
            lines.push('## 影響のあるパッケージ (最大10件)');
            lines.push('');
            vulnerabilities.slice(0, 10).forEach((entry) => {
              const via = Array.isArray(entry.via)
                ? entry.via.filter((item) => typeof item === 'object')
                : [];
              lines.push(
                `- **${entry.name}** ${entry.range ?? ''} / severity: ${entry.severity}`
              );
              via.forEach((advisory) => {
                const title = advisory.title ?? advisory.url ?? advisory.source;
                const url = advisory.url ? ` (${advisory.url})` : '';
                lines.push(`    - ${title} [${advisory.severity}]${url}`);
              });
            });
          }

          const summary = `${lines.join('\n')}\n`;
          fs.writeFileSync(summaryPath, summary);
          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);

          fs.appendFileSync(process.env.GITHUB_OUTPUT, `total=${total}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `highest=${highest}\n`);
          fs.appendFileSync(
            process.env.GITHUB_OUTPUT,
            `summary_path=${summaryPath}\n`
          );
          fs.appendFileSync(
            process.env.GITHUB_OUTPUT,
            `has_findings=${total > 0}\n`
          );
          NODE

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: |
            audit-report.json
            audit-summary.md

      - name: Create or update audit issue
        id: ensure_issue
        if: steps.summarize.outputs.total != '0'
        uses: actions/github-script@v7
        env:
          SUMMARY_PATH: ${{ steps.summarize.outputs.summary_path }}
          AUDIT_ISSUE_TITLE: npm audit alerts (production)
          AUDIT_ISSUE_LABEL: security
        with:
          script: |
            const fs = require('fs');
            const { owner, repo } = context.repo;

            const summary = fs.readFileSync(process.env.SUMMARY_PATH, 'utf8');
            const title =
              process.env.AUDIT_ISSUE_TITLE ?? 'npm audit alerts (production)';
            const labelName = process.env.AUDIT_ISSUE_LABEL;

            if (labelName) {
              try {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: labelName,
                  color: 'B60205',
                });
              } catch (error) {
                if (error.status !== 422) {
                  throw error;
                }
              }
            }

            const { data: openIssues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              per_page: 100,
            });

            let issue = openIssues.find((item) => item.title === title);
            const body = `### ${new Date().toISOString()}\n\n${summary}`;

            if (!issue) {
              const payload = { owner, repo, title, body };
              if (labelName) {
                payload.labels = [labelName];
              }
              issue = (await github.rest.issues.create(payload)).data;
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body,
              });
            }

            return { issueNumber: issue.number };

      - name: Notify Slack (optional)
        if: steps.summarize.outputs.total != '0' && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "npm audit で ${{ steps.summarize.outputs.total }} 件の脆弱性を検出しました。Issue #${{ fromJson(steps.ensure_issue.outputs.result).issueNumber }} を確認してください。"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

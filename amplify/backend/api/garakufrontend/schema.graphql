# This "input" configures a global authorization rule to enable public access to
# all models in this schema. Learn more about authorization rules here: https://docs.amplify.aws/cli/graphql/authorization-rules
input AMPLIFY {
  globalAuthRule: AuthRule = { allow: public }
} # FOR TESTING ONLY!
type Staff @model @auth(rules: [{ allow: private }]) {
  id: ID!
  cognitoUserId: String!
    @index(
      name: "byCognitoUserId"
      sortKeyFields: ["id"]
      queryField: "staffByCognitoUserId"
    )
  familyName: String
  givenName: String
  mailAddress: String!
  role: String!
  enabled: Boolean!
  status: String!
  owner: Boolean
  usageStartDate: String
  notifications: Notification
  externalLinks: [StaffExternalLink]
  sortKey: String
  workType: String
  developer: Boolean
  approverSetting: ApproverSettingMode
  approverSingle: String
  approverMultiple: [String]
  approverMultipleMode: ApproverMultipleMode
  shiftGroup: String
}

enum ApproverSettingMode {
  ADMINS
  SINGLE
  MULTIPLE
}

enum ApproverMultipleMode {
  ANY
  ORDER
}

type Notification {
  workStart: Boolean
  workEnd: Boolean
}

type StaffExternalLink {
  label: String!
  url: String!
  enabled: Boolean!
  icon: String!
}

type HolidayCalendar @model @auth(rules: [{ allow: private }]) {
  id: ID!
  holidayDate: String!
  name: String!
}

type CompanyHolidayCalendar @model @auth(rules: [{ allow: private }]) {
  id: ID!
  holidayDate: String!
  name: String!
}

type CloseDate @model @auth(rules: [{ allow: private }]) {
  id: ID!
  closeDate: String!
  startDate: String!
  endDate: String!
}

type SystemComment {
  comment: String!
  confirmed: Boolean!
  createdAt: String!
}

type Attendance @model @auth(rules: [{ allow: private }]) {
  id: ID!
  staffId: String!
    @index(
      name: "byStaffId"
      sortKeyFields: ["workDate"]
      queryField: "attendancesByStaffId"
    )
  workDate: String!
  startTime: String
  endTime: String
  goDirectlyFlag: Boolean
  returnDirectlyFlag: Boolean
  absentFlag: Boolean
  rests: [Rest]
  hourlyPaidHolidayTimes: [HourlyPaidHolidayTime]
  remarks: String
  paidHolidayFlag: Boolean
  specialHolidayFlag: Boolean
  isDeemedHoliday: Boolean
  hourlyPaidHolidayHours: Int
  substituteHolidayDate: String
  histories: [AttendanceHistory]
  changeRequests: [AttendanceChangeRequest]
  systemComments: [SystemComment]
  revision: Int
}

type Document @model @auth(rules: [{ allow: private }]) {
  id: ID!
  title: String!
  content: String!
  tag: [String]
  targetRole: [String]
  revision: Int
}

type CheckForUpdate @model {
  id: ID!
  deployUuid: String!
}

type Rest {
  startTime: String
  endTime: String
}

type AttendanceHistory {
  staffId: String!
  workDate: String!
  startTime: String
  endTime: String
  goDirectlyFlag: Boolean
  absentFlag: Boolean
  returnDirectlyFlag: Boolean
  rests: [Rest]
  hourlyPaidHolidayTimes: [HourlyPaidHolidayTime]
  remarks: String
  paidHolidayFlag: Boolean
  specialHolidayFlag: Boolean
  hourlyPaidHolidayHours: Int
  substituteHolidayFlag: Boolean
  substituteHolidayDate: String
  createdAt: String!
}

type AttendanceChangeRequest {
  startTime: String
  endTime: String
  goDirectlyFlag: Boolean
  absentFlag: Boolean
  returnDirectlyFlag: Boolean
  rests: [Rest]
  hourlyPaidHolidayTimes: [HourlyPaidHolidayTime]
  remarks: String
  paidHolidayFlag: Boolean
  specialHolidayFlag: Boolean
  hourlyPaidHolidayHours: Int
  substituteHolidayFlag: Boolean
  substituteHolidayDate: String
  completed: Boolean
  comment: String
  staffComment: String
}

type Link {
  label: String!
  url: String!
  enabled: Boolean!
  icon: String
}

type Reason {
  reason: String!
  enabled: Boolean!
}

type QuickInputTime {
  time: String!
  enabled: Boolean!
}

type ShiftGroup {
  label: String!
  description: String
  min: Int
  max: Int
  fixed: Int
}

enum ShiftRequestStatus {
  WORK
  FIXED_OFF
  REQUESTED_OFF
  AUTO
}

type ShiftRequestDayPreference {
  date: String!
  status: ShiftRequestStatus!
}

type ShiftRequestSummary {
  workDays: Int
  fixedOffDays: Int
  requestedOffDays: Int
}

type ShiftRequestHistory {
  version: Int!
  note: String
  entries: [ShiftRequestDayPreference]
  summary: ShiftRequestSummary
  submittedAt: String
  updatedAt: String
  recordedAt: String!
  recordedByStaffId: String
  changeReason: String
}

type ShiftRequest @model @auth(rules: [{ allow: private }]) {
  id: ID!
  staffId: String!
    @index(
      name: "shiftRequestsByStaffId"
      sortKeyFields: ["targetMonth"]
      queryField: "shiftRequestsByStaffId"
    )
  targetMonth: String!
  note: String
  entries: [ShiftRequestDayPreference]
  summary: ShiftRequestSummary
  submittedAt: String
  updatedAt: String
  # 共同編集用フィールド
  updatedBy: String # 最終更新者のユーザーID
  version: Int # 楽観的ロック用バージョン番号
  # 変更履歴（最新が先頭になるようクライアントで整列）
  histories: [ShiftRequestHistory]
}

type ShiftPlanMonthSetting {
  month: Int!
  editStart: String
  editEnd: String
  enabled: Boolean
  dailyCapacities: [Int]
}

type ShiftPlanYear @model @auth(rules: [{ allow: private }]) {
  id: ID!
  targetYear: Int!
    @index(
      name: "shiftPlanYearByTargetYear"
      sortKeyFields: ["id"]
      queryField: "shiftPlanYearByTargetYear"
    )
  plans: [ShiftPlanMonthSetting]
  notes: String
  createdBy: String
  updatedBy: String
}

type AppConfig @model {
  id: ID!
  name: String!
  workStartTime: String
  workEndTime: String
  lunchRestStartTime: String
  lunchRestEndTime: String
  standardWorkHours: Float
  amHolidayStartTime: String
  amHolidayEndTime: String
  pmHolidayStartTime: String
  pmHolidayEndTime: String
  specialHolidayEnabled: Boolean
  amPmHolidayEnabled: Boolean
  officeMode: Boolean
  attendanceStatisticsEnabled: Boolean
  absentEnabled: Boolean
  hourlyPaidHolidayEnabled: Boolean
  links: [Link]
  reasons: [Reason]
  quickInputStartTimes: [QuickInputTime]
  quickInputEndTimes: [QuickInputTime]
  themeColor: String
  shiftGroups: [ShiftGroup]
}

type EmailResult {
  statusCode: Int
  body: String
}

input EmailData {
  to: [String]
  subject: String!
  body: String!
}

type Query {
  sendMail(data: EmailData!): EmailResult
    @function(name: "garakuSendMail-${env}")
}

type HourlyPaidHolidayTime {
  startTime: String!
  endTime: String!
}

enum WorkflowCategory {
  PAID_LEAVE
  ABSENCE
  OVERTIME
  CLOCK_CORRECTION
  CUSTOM
}

enum WorkflowStatus {
  DRAFT
  SUBMITTED
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

type OverTimeWorkflow {
  date: String!
  startTime: String!
  endTime: String!
  reason: String!
}

type WorkflowComment {
  id: ID!
  staffId: String!
  text: String!
  createdAt: String!
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  SKIPPED
}

type ApprovalStep {
  id: ID!
  approverStaffId: String!
  decisionStatus: ApprovalStatus!
  approverComment: String
  decisionTimestamp: String
  stepOrder: Int
}

type Workflow @model @auth(rules: [{ allow: private }]) {
  id: ID!
  approvedStaffIds: [String]
  rejectedStaffIds: [String]
  finalDecisionTimestamp: String
  category: WorkflowCategory
  staffId: String! @index(name: "byStaffId", queryField: "workflowsByStaffId")
  status: WorkflowStatus!
  assignedApproverStaffIds: [String]
  approvalSteps: [ApprovalStep]
  nextApprovalStepIndex: Int
  submitterApproverSetting: ApproverSettingMode
  submitterApproverId: String
  submitterApproverIds: [String]
  submitterApproverMultipleMode: ApproverMultipleMode
  overTimeDetails: OverTimeWorkflow
  comments: [WorkflowComment]
}

type OperationLog @model @auth(rules: [{ allow: private }]) {
  id: ID!
  staffId: String
    @index(
      name: "byStaffId"
      sortKeyFields: ["timestamp"]
      queryField: "operationLogsByStaffId"
    )
  # 行った操作の種類（例: "LOGIN", "ATTENDANCE_UPDATE"）
  action: String!
  # 対象リソースの種類（例: "Attendance", "Workflow", "AppConfig"）
  resource: String
  # 対象リソースの ID（あれば）
  resourceId: String
  # ISO 8601 形式のタイムスタンプ
  timestamp: String!
  # 操作の詳細を JSON 文字列などで保存
  details: String
  # オプション: 発生元 IP
  ipAddress: String
  # オプション: ユーザーエージェント
  userAgent: String
  # 任意の追加メタデータ（JSON 文字列）
  metadata: String
  # 重大度レベル（例: INFO, WARN, ERROR）
  severity: String
}

type AuditLog @model @auth(rules: [{ allow: groups, groups: ["Admin"] }]) {
  id: ID!
  resourceType: String!
  resourceId: String!
  action: String!
  actorId: ID!
  actorRole: String
  requestId: String!
  ip: String
  userAgent: String
  before: AWSJSON
  after: AWSJSON
  diff: AWSJSON
  createdAt: AWSDateTime!
  ttl: AWSTimestamp
  reason: String
}

enum DailyReportStatus {
  DRAFT
  SUBMITTED
  APPROVED
}

enum DailyReportReactionType {
  CHEER
  CHECK
  THANKS
  LOOK
}

type DailyReportReaction {
  staffId: String!
  type: DailyReportReactionType!
  createdAt: String!
}

type DailyReportComment {
  id: ID!
  staffId: String!
  authorName: String
  body: String!
  createdAt: String!
}

type DailyReport @model @auth(rules: [{ allow: private }]) {
  id: ID!
  staffId: String!
    @index(
      name: "dailyReportsByStaffId"
      sortKeyFields: ["reportDate"]
      queryField: "dailyReportsByStaffId"
    )
  reportDate: String!
  title: String!
  content: String
  status: DailyReportStatus!
  updatedAt: String
  reactions: [DailyReportReaction]
  comments: [DailyReportComment]
}

# 共同編集用のバッチ更新型
input ShiftRequestBatchUpdateInput {
  id: ID!
  staffId: String!
  targetMonth: String!
  entries: [ShiftRequestDayPreferenceInput]
  expectedVersion: Int # 楽観的ロック用
  updatedBy: String!
}

input ShiftRequestDayPreferenceInput {
  date: String!
  status: ShiftRequestStatus!
}

type ShiftRequestBatchUpdateResult {
  success: Boolean!
  updatedRequests: [ShiftRequest]
  errors: [ShiftRequestBatchError]
}

type ShiftRequestBatchError {
  id: ID!
  message: String!
  code: String
}
